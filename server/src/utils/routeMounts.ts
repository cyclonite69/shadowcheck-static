/**
 * Route mounting helpers for the main server bootstrap.
 */
import type { Express, Router } from 'express';
import type { QueryResult } from 'pg';

type QueryFunction = (text: string, params?: unknown[]) => Promise<QueryResult>;

interface DashboardRoutesModule {
  router: Router;
  initDashboardRoutes: (deps: { dashboardService: unknown }) => void;
}

interface ApiRouteDependencies {
  healthRoutes: Router;
  geospatialRoutes: Router;
  networksRoutes: Router;
  threatsRoutes: Router;
  wigleRoutes: Router;
  adminRoutes: Router;
  explorerRoutes: Router;
  mlRoutes: Router;
  analyticsRoutes: Router;
  dashboardRoutes: DashboardRoutesModule;
  networksV2Routes: Router;
  threatsV2Routes: Router;
  filteredRoutes: Router;
  locationMarkersRoutes: Router;
  homeLocationRoutes: Router;
  keplerRoutes: Router;
  backupRoutes: Router;
  exportRoutes: Router;
  analyticsPublicRoutes: Router;
  settingsRoutes: Router;
  networkTagsRoutes: Router;
  authRoutes: Router;
  weatherRoutes: Router;
}

/**
 * Mount demo routes (must run before static asset middleware).
 */
function mountDemoRoutes(app: Express, miscRoutes: Router): void {
  app.use('/', miscRoutes);
}

/**
 * Mount API and page routes (must run after static assets).
 */
function mountApiRoutes(app: Express, deps: ApiRouteDependencies): void {
  const {
    healthRoutes,
    geospatialRoutes,
    networksRoutes,
    threatsRoutes,
    wigleRoutes,
    adminRoutes,
    explorerRoutes,
    mlRoutes,
    analyticsRoutes,
    dashboardRoutes,
    networksV2Routes,
    threatsV2Routes,
    filteredRoutes,
    locationMarkersRoutes,
    homeLocationRoutes,
    keplerRoutes,
    backupRoutes,
    exportRoutes,
    analyticsPublicRoutes,
    settingsRoutes,
    networkTagsRoutes,
    authRoutes,
    weatherRoutes,
  } = deps;

  // Debug: Check for undefined routes
  const routes = {
    healthRoutes,
    geospatialRoutes,
    networksRoutes,
    threatsRoutes,
    wigleRoutes,
    adminRoutes,
    explorerRoutes,
    mlRoutes,
    analyticsRoutes,
    networksV2Routes,
    threatsV2Routes,
    filteredRoutes,
    homeLocationRoutes,
    keplerRoutes,
    backupRoutes,
    exportRoutes,
    analyticsPublicRoutes,
    settingsRoutes,
    networkTagsRoutes,
    authRoutes,
    weatherRoutes,
  };

  for (const [name, route] of Object.entries(routes)) {
    if (!route) {
      console.error(`[ROUTE ERROR] ${name} is undefined!`);
    }
  }

  // Health check (no prefix, available at /health)
  app.use('/', healthRoutes);

  // Geospatial routes (includes root redirect)
  app.use('/', geospatialRoutes);

  // Export routes (no auth required) - mount first
  app.use('/api', exportRoutes);

  // Public analytics routes (no auth required) - mount outside /api
  app.use('/analytics-public', analyticsPublicRoutes);

  // Weather proxy (no auth required)
  // TEMPORARILY DISABLED - TypeScript ES module compatibility issue
  // app.use('/', weatherRoutes);

  // Agency offices (public data - mount outside /api to avoid admin auth middleware)
  const agencyOfficesRoutes = require('../api/routes/v1/agencyOffices').default;
  app.use('/agency-offices', agencyOfficesRoutes);

  // API routes
  app.use('/api', authRoutes);
  app.use('/api', networksRoutes);
  app.use('/api', threatsRoutes);
  app.use('/api', wigleRoutes);
  app.use('/api', explorerRoutes);
  app.use('/api', mlRoutes);
  app.use('/api/analytics', analyticsRoutes);
  app.use('/api', dashboardRoutes.router);
  app.use('/api/v2/networks/filtered', filteredRoutes);
  app.use('/api', networksV2Routes);
  app.use('/api/v2', threatsV2Routes);
  app.use('/api', locationMarkersRoutes);
  app.use('/api', homeLocationRoutes);
  app.use('/api', keplerRoutes);
  app.use('/api', backupRoutes);
  app.use('/api', settingsRoutes);
  app.use('/api/network-tags', networkTagsRoutes);

  // Network agencies (nearest agencies to network observations)
  const networkAgenciesRoutes = require('../api/routes/v1/network-agencies');
  app.use('/api/networks', networkAgenciesRoutes);

  // Admin routes (MUST BE LAST - has requireAdmin middleware on all routes)
  app.use('/api', adminRoutes);
}

export { mountDemoRoutes, mountApiRoutes, ApiRouteDependencies, DashboardRoutesModule };
