// Clear PostgreSQL environment variables that might interfere
delete process.env.PGHOST;
delete process.env.PGPORT;
delete process.env.PGDATABASE;
delete process.env.PGUSER;

(async () => {
  try {
    // ============================================================================
    // 1. CORE DEPENDENCIES
    // ============================================================================
    require('dotenv').config({ override: true });
    const logger = require('./src/logging/logger');
    const express = require('express');
    const path = require('path');
    const cors = require('cors');
    const compression = require('compression');
    const rateLimit = require('express-rate-limit');

    logger.info('Starting server...');

    // ============================================================================
    // 2. SECRETS MANAGEMENT
    // ============================================================================
    const { validateSecrets } = require('./src/utils/validateSecrets');
    const secretsManager = require('./src/services/secretsManager');

    await validateSecrets();

    // ============================================================================
    // 3. UTILITIES & ERROR HANDLING
    // ============================================================================
    const { createErrorHandler, notFoundHandler } = require('./src/errors/errorHandler');

    // ============================================================================
    // 4. ROUTE MODULES
    // ============================================================================
    const healthRoutes = require('./src/api/routes/v1/health');
    const networksRoutes = require('./src/api/routes/v1/networks');
    const explorerRoutes = require('./src/api/routes/v1/explorer');
    const threatsRoutes = require('./src/api/routes/v1/threats');
    const wigleRoutes = require('./src/api/routes/v1/wigle');
    const adminRoutes = require('./src/api/routes/v1/admin');
    const mlRoutes = require('./src/api/routes/v1/ml');
    const geospatialRoutes = require('./src/api/routes/v1/geospatial');
    const analyticsRoutes = require('./src/api/routes/v1/analytics');
    const networksV2Routes = require('./src/api/routes/v2/networks');
    const filteredRoutes = require('./src/api/routes/v2/filtered');
    const dashboardRoutes = require('./src/api/routes/v1/dashboard');
    const locationMarkersRoutes = require('./src/api/routes/v1/location-markers');
    const homeLocationRoutes = require('./src/api/routes/v1/home-location');
    const keplerRoutes = require('./src/api/routes/v1/kepler');
    const backupRoutes = require('./src/api/routes/v1/backup');
    const exportRoutes = require('./src/api/routes/v1/export');
    const settingsRoutes = require('./src/api/routes/v1/settings');
    const networkTagsRoutes = require('./src/api/routes/v1/network-tags');
    const miscRoutes = require('./src/api/routes/v1/misc');

    // ============================================================================
    // 5. APP INITIALIZATION
    // ============================================================================
    const app = express();
    const port = process.env.PORT || 3001;
    const host = process.env.HOST || '0.0.0.0';
    const FORCE_HTTPS = process.env.FORCE_HTTPS === 'true';

    // ============================================================================
    // 6. MIDDLEWARE SETUP
    // ============================================================================

    // Request ID middleware (first, so all requests have IDs)
    const requestIdMiddleware = require('./src/middleware/requestId');
    app.use(requestIdMiddleware);

    // HTTPS redirect (if enabled)
    if (FORCE_HTTPS) {
      app.use((req, res, next) => {
        if (req.headers['x-forwarded-proto'] !== 'https' && req.hostname !== 'localhost') {
          return res.redirect(301, `https://${req.hostname}${req.url}`);
        }
        next();
      });
    }

    // Security headers
    app.use((req, res, next) => {
      res.setHeader('X-Content-Type-Options', 'nosniff');
      res.setHeader('X-Frame-Options', 'DENY');
      res.setHeader('X-XSS-Protection', '1; mode=block');
      res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
      if (FORCE_HTTPS) {
        res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
      }
      res.setHeader(
        'Content-Security-Policy',
        "default-src 'self'; " +
          "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://api.mapbox.com; " +
          "worker-src 'self' blob:; " +
          "style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com https://api.mapbox.com; " +
          "font-src 'self' https://fonts.gstatic.com; " +
          "img-src 'self' data: https:; " +
          "connect-src 'self' https://api.mapbox.com https://*.tiles.mapbox.com https://events.mapbox.com https://d1a3f4spazzrp4.cloudfront.net;"
      );
      next();
    });

    // Compression
    app.use(compression());

    // CORS
    const allowedOrigins = process.env.CORS_ORIGINS
      ? process.env.CORS_ORIGINS.split(',').map((o) => o.trim())
      : ['http://localhost:3001', 'http://127.0.0.1:3001'];

    app.use(
      cors({
        origin: function (origin, callback) {
          if (!origin) {
            return callback(null, true);
          }
          if (allowedOrigins.indexOf(origin) !== -1 || allowedOrigins.includes('*')) {
            callback(null, true);
          } else {
            callback(new Error('Not allowed by CORS'));
          }
        },
        credentials: true,
      })
    );

    // Rate limiting
    const apiLimiter = rateLimit({
      windowMs: 15 * 60 * 1000,
      max: 1000,
      message: 'Too many requests from this IP, please try again after 15 minutes',
    });
    app.use('/api/', apiLimiter);

    // Body parsing
    app.use(express.json({ limit: '10mb' }));
    app.use(express.urlencoded({ extended: true, limit: '10mb' }));

    // ============================================================================
    // 7. DATABASE SETUP
    // ============================================================================
    const { pool, query, testConnection } = require('./src/config/database');

    pool.on('connect', (client) => {
      logger.debug(`Pool connected: ${client.host}:${client.port}`);
    });

    // Fail fast if the database is unreachable or misconfigured
    await testConnection();

    // ============================================================================
    // 8. DEMO ROUTES (before static files)
    // ============================================================================
    app.use('/', miscRoutes);

    // ============================================================================
    // 9. STATIC FILES
    // ============================================================================
    const { mountStaticAssets } = require('./src/middleware/staticAssets');
    mountStaticAssets(app, path.join(__dirname, 'dist'));

    // ============================================================================
    // 10. ROUTE MOUNTING
    // ============================================================================

    // Make secretsManager available to routes
    app.locals.secretsManager = secretsManager;

    // Initialize dashboard routes with dependencies
    const NetworkRepository = require('./src/repositories/networkRepository');
    const DashboardService = require('./src/services/dashboardService');
    const networkRepository = new NetworkRepository();
    const dashboardService = new DashboardService(networkRepository);
    dashboardRoutes.initDashboardRoutes({ dashboardService });

    // Health check (no prefix, available at /health)
    app.use('/', healthRoutes);

    // Geospatial routes (includes root redirect)
    app.use('/', geospatialRoutes);

    // API routes
    app.use('/api', networksRoutes);
    app.use('/api', threatsRoutes);
    app.use('/api', wigleRoutes);
    app.use('/api', adminRoutes);
    app.use('/api', explorerRoutes);
    app.use('/api', mlRoutes);
    app.use('/api/analytics', analyticsRoutes);
    app.use('/api', dashboardRoutes.router);
    app.use('/api/v2/networks/filtered', filteredRoutes);
    app.use('/api', networksV2Routes);
    app.use('/api', locationMarkersRoutes(query));
    app.use('/api', homeLocationRoutes);
    app.use('/api', keplerRoutes);
    app.use('/api', backupRoutes);
    app.use('/api', exportRoutes);
    app.use('/api', settingsRoutes);
    app.use('/api/network-tags', networkTagsRoutes);

    logger.info('All routes mounted successfully');

    // Initialize background jobs
    const BackgroundJobsService = require('./src/services/backgroundJobsService');
    await BackgroundJobsService.initialize();

    // ============================================================================
    // 10. SPA FALLBACK (React Router support)
    // ============================================================================
    // Serve index.html for all non-API routes (must be after API routes)
    const { createSpaFallback } = require('./src/middleware/spaFallback');
    app.get('*', createSpaFallback(path.join(__dirname, 'dist')));

    // ============================================================================
    // 11. ERROR HANDLING
    // ============================================================================
    app.use(notFoundHandler);
    app.use(createErrorHandler(logger));

    // ============================================================================
    // 12. SERVER STARTUP
    // ============================================================================
    app.listen(port, host, () => {
      logger.info(`Server listening on port ${port}`);
      logger.info(`Environment: ${process.env.NODE_ENV || 'development'}`);
      logger.info(`HTTPS redirect: ${FORCE_HTTPS ? 'enabled' : 'disabled'}`);
    });

    // Graceful shutdown
    process.on('SIGTERM', async () => {
      logger.info('SIGTERM received, closing server gracefully...');
      const BackgroundJobsService = require('./src/services/backgroundJobsService');
      BackgroundJobsService.shutdown();
      await pool.end();
      process.exit(0);
    });

    process.on('SIGINT', async () => {
      logger.info('SIGINT received, closing server gracefully...');
      await pool.end();
      process.exit(0);
    });
  } catch (err) {
    console.error(err); // PRINT STACK TRACE
    const logger = require('./src/logging/logger');
    logger.error(`Fatal error starting server: ${err.message}`, { error: err });
    process.exit(1);
  }
})();
