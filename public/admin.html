<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowCheck - Admin</title>
    <link rel="stylesheet" href="/assets/styles/unified.css">
</head>
<body data-page="admin">
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <div class="logo">SC</div>
                <span class="font-semibold">ShadowCheck</span>
            </div>
            <nav class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/networks.html" class="nav-link">Networks</a>
                <a href="/geospatial.html" class="nav-link">Geospatial</a>
                <a href="/surveillance.html" class="nav-link">Surveillance</a>
                <a href="/analytics.html" class="nav-link">Analytics</a>
                <a href="/admin.html" class="nav-link active">Admin</a>
            </nav>
            <div class="header-right">
                <button class="btn btn-sm" onclick="window.baseComponents?.showCardLibrary()">‚ûï Add Card</button>
                <button class="btn btn-sm" onclick="window.baseComponents?.toggleSnap(this)">üî≤ Snap: ON</button>
                <button class="btn btn-sm" onclick="window.baseComponents?.resetLayout()">‚Ü∫ Reset</button>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Online</span>
                </div>
            </div>
        </header>

        <main class="app-main">
            <div class="grid grid-3 mb-3" style="grid-template-rows: 1fr 1fr; flex: 1; gap: 12px;">
                <div class="panel">
                    <div class="panel-header">üì° WiGLE API</div>
                    <div class="panel-body">
                        <div class="text-sm text-secondary mb-2">üîí Stored in system keyring</div>
                        <div id="wigle-status"></div>
                        
                        <div class="mb-2">
                            <label class="text-xs font-medium mb-1" style="display: block;">API Name</label>
                            <input type="text" id="wigle-api-name" placeholder="AIDxxxxx..." style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; font-size: 12px;">
                        </div>
                        
                        <div class="mb-2">
                            <label class="text-xs font-medium mb-1" style="display: block;">API Token</label>
                            <input type="password" id="wigle-api-token" placeholder="xxxxxxxx..." style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; font-size: 12px;">
                        </div>
                        
                        <button class="btn mb-2" onclick="saveWigle()" style="width: 100%;">Save & Test</button>
                        <button class="btn btn-secondary mb-2" onclick="testWigle()" style="width: 100%;">Test Connection</button>
                        
                        <div id="wigle-result"></div>

                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="text-sm font-semibold mb-2">üîç WiGLE API Tools</div>
                            
                            <div class="mb-2">
                                <label class="text-xs font-medium mb-1" style="display: block;">Search by BSSID</label>
                                <input type="text" id="wigle-bssid" placeholder="AA:BB:CC:DD:EE:FF" style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; font-size: 12px;">
                            </div>
                            
                            <div class="mb-2">
                                <label class="text-xs font-medium mb-1" style="display: block;">Search by SSID</label>
                                <input type="text" id="wigle-ssid" placeholder="Network Name" style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; font-size: 12px;">
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="wigleSearchBSSID()">Search BSSID</button>
                                <button class="btn btn-sm" onclick="wigleSearchSSID()">Search SSID</button>
                                <button class="btn btn-sm" onclick="wigleSearchBounds()">Search Area</button>
                            </div>
                            
                            <div id="wigle-search-result" style="margin-top: 12px;"></div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">üó∫Ô∏è Mapbox Tokens</div>
                    <div class="panel-body">
                        <div id="mapbox-tokens-list" style="margin-bottom: 15px;"></div>
                        
                        <div class="mb-2">
                            <label class="text-xs font-medium mb-1" style="display: block;">Label</label>
                            <input type="text" id="mapbox-label" placeholder="default" value="default" style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; font-size: 12px;">
                        </div>
                        
                        <div class="mb-2">
                            <label class="text-xs font-medium mb-1" style="display: block;">Access Token</label>
                            <input type="password" id="mapbox-token" placeholder="pk.xxxxx..." style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; font-size: 12px;">
                        </div>
                        
                        <button class="btn mb-2" onclick="saveMapbox()" style="width: 100%;">Save Token</button>
                        <button class="btn btn-secondary mb-2" onclick="loadMapboxTokens()" style="width: 100%;">Refresh List</button>
                        
                        <div id="mapbox-result"></div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">üíæ Database</div>
                    <div class="panel-body">
                        <button class="btn btn-secondary mb-2" onclick="backup()" style="width: 100%;">Backup Database</button>
                        <button class="btn btn-secondary mb-2" onclick="restore()" style="width: 100%;">Restore Database</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">üåç Export GeoJSON</div>
                    <div class="panel-body">
                        <button class="btn btn-secondary" onclick="exportGeoJSON()" style="width: 100%;">Download GeoJSON</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">üìÑ Export JSON</div>
                    <div class="panel-body">
                        <button class="btn btn-secondary" onclick="exportJSON()" style="width: 100%;">Download JSON</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">üìä Export CSV</div>
                    <div class="panel-body">
                        <button class="btn btn-secondary" onclick="exportCSV()" style="width: 100%;">Download CSV</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let API_KEY = localStorage.getItem('shadowcheck_api_key') || '';

        window.addEventListener('DOMContentLoaded', () => {
            if (!API_KEY) {
                API_KEY = 'your-secure-random-key-here';
                localStorage.setItem('shadowcheck_api_key', API_KEY);
            }
            loadWigleStatus();
            loadMapboxTokens();
        });

        async function api(url, options = {}) {
            options.headers = { ...options.headers, 'X-API-Key': API_KEY, 'Content-Type': 'application/json' };
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        async function loadWigleStatus() {
            try {
                const data = await api('/api/settings/wigle');
                document.getElementById('wigle-status').innerHTML = data.configured 
                    ? `<div style="padding: 4px 10px; border-radius: 4px; font-size: 11px; background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); margin-bottom: 12px;">‚úì ${data.apiName} / ${data.apiToken}</div>`
                    : `<div style="padding: 4px 10px; border-radius: 4px; font-size: 11px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); margin-bottom: 12px;">‚ö† Not configured</div>`;
            } catch (e) {}
        }

        async function saveWigle() {
            const apiName = document.getElementById('wigle-api-name').value;
            const apiToken = document.getElementById('wigle-api-token').value;
            if (!apiName || !apiToken) return alert('Enter both fields');

            try {
                const result = await api('/api/settings/wigle', {
                    method: 'POST',
                    body: JSON.stringify({ apiName, apiToken })
                });

                document.getElementById('wigle-result').innerHTML = result.test.success
                    ? `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-top: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981;">‚úì Saved! User: ${result.test.user}</div>`
                    : `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-top: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">Saved but test failed: ${result.test.error}</div>`;
                
                loadWigleStatus();
            } catch (e) {
                document.getElementById('wigle-result').innerHTML = `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-top: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">Failed: ${e.message}</div>`;
            }
        }

        async function testWigle() {
            try {
                const result = await api('/api/settings/wigle/test');
                document.getElementById('wigle-result').innerHTML = result.success
                    ? `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-top: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981;">‚úì Connected! User: ${result.user}</div>`
                    : `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-top: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">Failed: ${result.error}</div>`;
            } catch (e) {
                document.getElementById('wigle-result').innerHTML = `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-top: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">Test failed: ${e.message}</div>`;
            }
        }

        async function wigleSearchBSSID() {
            const bssid = document.getElementById('wigle-bssid').value.trim();
            if (!bssid) return alert('Enter BSSID');
            
            const result = document.getElementById('wigle-search-result');
            result.innerHTML = '<div class="text-sm text-secondary">Searching...</div>';
            
            try {
                const data = await api(`/api/wigle/network/${encodeURIComponent(bssid)}`);
                if (data.success && data.results && data.results.length > 0) {
                    const net = data.results[0];
                    result.innerHTML = `
                        <div style="background: rgba(30, 41, 59, 0.5); padding: 12px; border-radius: 6px; font-size: 12px;">
                            <div><strong>SSID:</strong> ${net.ssid || 'Hidden'}</div>
                            <div><strong>BSSID:</strong> ${net.netid}</div>
                            <div><strong>Encryption:</strong> ${net.encryption || 'Unknown'}</div>
                            <div><strong>Location:</strong> ${net.trilat}, ${net.trilong}</div>
                            <div><strong>Last Seen:</strong> ${net.lasttime}</div>
                            <div><strong>Channel:</strong> ${net.channel || 'N/A'}</div>
                        </div>
                    `;
                } else {
                    result.innerHTML = '<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3);">No results found</div>';
                }
            } catch (e) {
                result.innerHTML = `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">Search failed: ${e.message}</div>`;
            }
        }

        async function wigleSearchSSID() {
            const ssid = document.getElementById('wigle-ssid').value.trim();
            if (!ssid) return alert('Enter SSID');
            
            const result = document.getElementById('wigle-search-result');
            result.innerHTML = '<div class="text-sm text-secondary">Searching...</div>';
            
            try {
                const data = await api(`/api/wigle/search?ssid=${encodeURIComponent(ssid)}`);
                if (data.success && data.results && data.results.length > 0) {
                    result.innerHTML = `
                        <div style="background: rgba(30, 41, 59, 0.5); padding: 12px; border-radius: 6px; font-size: 12px;">
                            <div><strong>Found ${data.resultCount} networks</strong></div>
                            ${data.results.slice(0, 5).map(net => `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                                    <div><strong>${net.ssid}</strong> (${net.netid})</div>
                                    <div>Location: ${net.trilat}, ${net.trilong}</div>
                                    <div>Last: ${net.lasttime}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    result.innerHTML = '<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3);">No results found</div>';
                }
            } catch (e) {
                result.innerHTML = `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">Search failed: ${e.message}</div>`;
            }
        }

        async function wigleSearchBounds() {
            const result = document.getElementById('wigle-search-result');
            result.innerHTML = '<div class="text-sm text-secondary">Searching current map area...</div>';
            
            try {
                const data = await api('/api/wigle/search?latrange1=43.0&latrange2=43.1&longrange1=-83.7&longrange2=-83.6');
                if (data.success && data.results && data.results.length > 0) {
                    result.innerHTML = `
                        <div style="background: rgba(30, 41, 59, 0.5); padding: 12px; border-radius: 6px; font-size: 12px;">
                            <div><strong>Found ${data.resultCount} networks in area</strong></div>
                            ${data.results.slice(0, 5).map(net => `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                                    <div><strong>${net.ssid || 'Hidden'}</strong> (${net.netid})</div>
                                    <div>Location: ${net.trilat}, ${net.trilong}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    result.innerHTML = '<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3);">No results found</div>';
                }
            } catch (e) {
                result.innerHTML = `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">Search failed: ${e.message}</div>`;
            }
        }

        async function saveMapbox() {
            const token = document.getElementById('mapbox-token').value;
            const label = document.getElementById('mapbox-label').value || 'default';
            if (!token) return alert('Enter token');

            try {
                await api('/api/settings/mapbox', {
                    method: 'POST',
                    body: JSON.stringify({ token, label })
                });
                
                document.getElementById('mapbox-result').innerHTML = `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-top: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981;">‚úì Token "${label}" saved!</div>`;
                document.getElementById('mapbox-token').value = '';
                loadMapboxTokens();
            } catch (e) {
                document.getElementById('mapbox-result').innerHTML = `<div style="padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-top: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">Failed: ${e.message}</div>`;
            }
        }

        async function loadMapboxTokens() {
            try {
                const data = await api('/api/settings/mapbox');
                const list = document.getElementById('mapbox-tokens-list');
                
                if (!data.tokens || data.tokens.length === 0) {
                    list.innerHTML = '<div class="text-sm text-secondary">No tokens saved</div>';
                    return;
                }
                
                list.innerHTML = '<div class="text-sm font-semibold mb-2">Saved Tokens:</div>' +
                    data.tokens.map(t => `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px; background: rgba(30, 41, 59, 0.5); border-radius: 4px; margin-bottom: 4px; font-size: 11px;">
                            <span style="flex: 1;">
                                <strong>${t.label}</strong> ${t.isPrimary ? '<span style="color: #10b981;">‚òÖ Primary</span>' : ''}
                                <br><code style="color: #94a3b8;">${t.token}</code>
                            </span>
                            ${!t.isPrimary ? `<button class="btn btn-sm" onclick="setPrimaryMapbox('${t.label}')">Set Primary</button>` : ''}
                            <button class="btn btn-sm" onclick="deleteMapboxToken('${t.label}')" style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4);">Delete</button>
                        </div>
                    `).join('');
            } catch (e) {
                console.error('Failed to load tokens:', e);
                const list = document.getElementById('mapbox-tokens-list');
                list.innerHTML = '<div class="text-sm text-secondary">Token management not available (use keyring or .env)</div>';
            }
        }

        async function setPrimaryMapbox(label) {
            try {
                await api('/api/settings/mapbox/primary', {
                    method: 'POST',
                    body: JSON.stringify({ label })
                });
                loadMapboxTokens();
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        async function deleteMapboxToken(label) {
            if (!confirm(`Delete token "${label}"?`)) return;
            try {
                await api(`/api/settings/mapbox/${label}`, { method: 'DELETE' });
                loadMapboxTokens();
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        function backup() { 
            if (!API_KEY) {
                alert('API key not set. Refresh the page.');
                return;
            }
            window.location.href = '/api/backup/backup?api_key=' + encodeURIComponent(API_KEY);
        }
        
        function restore() { 
            if (!API_KEY) {
                alert('API key not set. Refresh the page.');
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('backup', file);
                
                try {
                    const res = await fetch('/api/backup/restore', {
                        method: 'POST',
                        headers: { 'X-API-Key': API_KEY },
                        body: formData
                    });
                    
                    if (res.ok) {
                        alert('‚úì Database restored successfully!');
                    } else {
                        const err = await res.json();
                        alert('‚úó Restore failed: ' + (err.error || res.statusText));
                    }
                } catch (e) {
                    alert('‚úó Restore failed: ' + e.message);
                }
            };
            input.click();
        }
        
        function exportGeoJSON() { 
            if (!API_KEY) {
                alert('API key not set. Refresh the page.');
                return;
            }
            window.location.href = '/api/export/geojson?api_key=' + encodeURIComponent(API_KEY); 
        }
        
        function exportJSON() { 
            if (!API_KEY) {
                alert('API key not set. Refresh the page.');
                return;
            }
            window.location.href = '/api/export/json?api_key=' + encodeURIComponent(API_KEY); 
        }
        
        function exportCSV() { 
            if (!API_KEY) {
                alert('API key not set. Refresh the page.');
                return;
            }
            window.location.href = '/api/export/csv?api_key=' + encodeURIComponent(API_KEY); 
        }
    </script>
    <script src="/assets/js/base-components.js"></script>
            }
        });
</body>
</html>
