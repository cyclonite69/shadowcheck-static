<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Model Training - ShadowCheck</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            color: #94a3b8;
            margin-bottom: 40px;
        }
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 6px;
        }
        .status-label { color: #94a3b8; }
        .status-value { color: #e0e7ff; font-weight: 600; }
        button {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover { opacity: 0.9; }
        button:disabled {
            background: rgba(148, 163, 184, 0.3);
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            display: none;
        }
        .result.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #4ade80;
        }
        .result.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #f87171;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        .feature {
            background: rgba(59, 130, 246, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        pre {
            background: rgba(15, 23, 42, 0.8);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 11px;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ ML Model Training</h1>
        <p class="subtitle">Train a machine learning model to automatically learn threat patterns from your tagged networks</p>

        <div class="card">
            <h3 style="margin-bottom: 16px;">Current Status</h3>
            <div class="status">
                <span class="status-label">Model Trained:</span>
                <span class="status-value" id="model-status">Loading...</span>
            </div>
            <div class="status">
                <span class="status-label">Tagged Threats:</span>
                <span class="status-value" id="threat-count">-</span>
            </div>
            <div class="status">
                <span class="status-label">Tagged Safe:</span>
                <span class="status-value" id="safe-count">-</span>
            </div>
            <div class="status">
                <span class="status-label">Last Updated:</span>
                <span class="status-value" id="last-updated">Never</span>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 12px;">How It Works</h3>
            <p style="color: #94a3b8; font-size: 14px; line-height: 1.6;">
                The ML model analyzes your tagged networks (threats vs safe) and automatically learns which features 
                (distance, signal strength, observation patterns) best predict real threats. It then generates 
                optimized scoring weights that reduce false positives while maintaining detection accuracy.
            </p>
            
            <h4 style="margin-top: 20px; margin-bottom: 8px; font-size: 14px;">Features Used:</h4>
            <div class="feature-list">
                <div class="feature">üìè Distance Range</div>
                <div class="feature">üìÖ Unique Days</div>
                <div class="feature">üëÅÔ∏è Observations</div>
                <div class="feature">üì∂ Signal Strength</div>
                <div class="feature">üìç Unique Locations</div>
                <div class="feature">üè† Home+Away Pattern</div>
            </div>

            <button id="train-btn" onclick="trainModel()">üöÄ Train Model Now</button>
            
            <div id="result" class="result"></div>
        </div>

        <div class="card">
            <a href="/analytics.html" style="color: #60a5fa; text-decoration: none;">‚Üê Back to Analytics</a>
        </div>
    </div>

    <script>
        const API_BASE = `${window.location.protocol}//${window.location.hostname}:3002/api`;

        async function loadStatus() {
            try {
                const res = await fetch(`${API_BASE}/ml/status`);
                const data = await res.json();

                document.getElementById('model-status').textContent = data.modelTrained ? '‚úì Yes' : '‚úó No';
                
                const threatCount = data.taggedNetworks.find(t => t.tag_type === 'THREAT')?.count || 0;
                const safeCount = data.taggedNetworks.find(t => t.tag_type === 'FALSE_POSITIVE')?.count || 0;
                
                document.getElementById('threat-count').textContent = threatCount;
                document.getElementById('safe-count').textContent = safeCount;
                
                if (data.modelInfo?.updated_at) {
                    document.getElementById('last-updated').textContent = new Date(data.modelInfo.updated_at).toLocaleString();
                }

                const total = threatCount + safeCount;
                if (total < 10) {
                    document.getElementById('train-btn').disabled = true;
                    document.getElementById('train-btn').textContent = `Need ${10 - total} more tagged networks`;
                }
            } catch (err) {
                console.error('Error loading status:', err);
            }
        }

        async function trainModel() {
            const btn = document.getElementById('train-btn');
            const result = document.getElementById('result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Training...';
            result.style.display = 'none';

            try {
                const res = await fetch(`${API_BASE}/ml/train`, { method: 'POST' });
                const data = await res.json();

                if (data.ok) {
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>‚úì Model Trained Successfully!</strong><br><br>
                        Training Samples: ${data.trainingSamples} (${data.threatCount} threats, ${data.safeCount} safe)<br>
                        Features: ${data.featureNames.join(', ')}<br>
                        <pre>${JSON.stringify(data.coefficients, null, 2)}</pre>
                    `;
                    loadStatus();
                } else {
                    throw new Error(data.error || 'Training failed');
                }
            } catch (err) {
                result.className = 'result error';
                result.innerHTML = `<strong>‚úó Training Failed</strong><br>${err.message}`;
            } finally {
                result.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'üöÄ Train Model Now';
            }
        }

        loadStatus();
    </script>
</body>
</html>
