<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowCheck - ML Training</title>
    <link rel="stylesheet" href="/assets/styles/unified.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <div class="logo">SC</div>
                <span class="font-semibold">ShadowCheck</span>
            </div>
            <nav class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/networks.html" class="nav-link">Networks</a>
                <a href="/geospatial.html" class="nav-link">Geospatial</a>
                <a href="/surveillance.html" class="nav-link">Surveillance</a>
                <a href="/analytics.html" class="nav-link">Analytics</a>
                <a href="/admin.html" class="nav-link">Admin</a>
            </nav>
            <div class="header-right">
                <a href="/analytics.html" class="btn btn-sm">â† Back</a>
            </div>
        </header>

        <main class="app-main" style="padding: 20px; max-width: 900px; margin: 0 auto;">
            <h1 style="font-size: 28px; margin-bottom: 8px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ğŸ¤– ML Model Training</h1>
            <p class="text-secondary mb-3">Train a machine learning model to automatically learn threat patterns from your tagged networks</p>

            <div class="panel mb-3">
                <div class="panel-header">Current Status</div>
                <div class="panel-body">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
                        <span class="text-secondary">Model Trained:</span>
                        <span class="font-semibold" id="model-status">Loading...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
                        <span class="text-secondary">Tagged Threats:</span>
                        <span class="font-semibold" id="threat-count">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
                        <span class="text-secondary">Tagged Safe:</span>
                        <span class="font-semibold" id="safe-count">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
                        <span class="text-secondary">Last Updated:</span>
                        <span class="font-semibold" id="last-updated">Never</span>
                    </div>
                </div>
            </div>

            <div class="panel mb-3">
                <div class="panel-header">How It Works</div>
                <div class="panel-body">
                    <p class="text-secondary text-sm mb-3" style="line-height: 1.6;">
                        The ML model analyzes your tagged networks (threats vs safe) and automatically learns which features 
                        (distance, signal strength, observation patterns) best predict real threats. It then generates 
                        optimized scoring weights that reduce false positives while maintaining detection accuracy.
                    </p>
                    
                    <div class="text-sm font-semibold mb-2">Features Used:</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 6px; font-size: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">ğŸ“ Distance Range</div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 6px; font-size: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">ğŸ“… Unique Days</div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 6px; font-size: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">ğŸ‘ï¸ Observations</div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 6px; font-size: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">ğŸ“¶ Signal Strength</div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 6px; font-size: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">ğŸ“ Unique Locations</div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 6px; font-size: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">ğŸ  Home+Away Pattern</div>
                    </div>

                    <button id="train-btn" class="btn" onclick="trainModel()" style="width: 100%;">ğŸš€ Train Model Now</button>
                    
                    <div id="result" style="margin-top: 20px; padding: 16px; border-radius: 8px; display: none;"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = `${window.location.protocol}//${window.location.hostname}:3001/api`;

        async function loadStatus() {
            try {
                const res = await fetch(`${API_BASE}/ml/status`);
                const data = await res.json();

                document.getElementById('model-status').textContent = data.modelTrained ? 'âœ“ Yes' : 'âœ— No';
                
                const threatCount = data.taggedNetworks.find(t => t.tag_type === 'THREAT')?.count || 0;
                const safeCount = data.taggedNetworks.find(t => t.tag_type === 'FALSE_POSITIVE')?.count || 0;
                
                document.getElementById('threat-count').textContent = threatCount;
                document.getElementById('safe-count').textContent = safeCount;
                
                if (data.modelInfo?.updated_at) {
                    document.getElementById('last-updated').textContent = new Date(data.modelInfo.updated_at).toLocaleString();
                }

                const total = threatCount + safeCount;
                if (total < 10) {
                    document.getElementById('train-btn').disabled = true;
                    document.getElementById('train-btn').textContent = `Need ${10 - total} more tagged networks`;
                }
            } catch (err) {
                console.error('Error loading status:', err);
            }
        }

        async function trainModel() {
            const btn = document.getElementById('train-btn');
            const result = document.getElementById('result');
            
            btn.disabled = true;
            btn.textContent = 'â³ Training...';
            result.style.display = 'none';

            try {
                const res = await fetch(`${API_BASE}/ml/train`, { method: 'POST' });
                const data = await res.json();

                if (data.ok) {
                    result.style.cssText = 'margin-top: 20px; padding: 16px; border-radius: 8px; display: block; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); color: #4ade80;';
                    result.innerHTML = `
                        <strong>âœ“ Model Trained Successfully!</strong><br><br>
                        Training Samples: ${data.trainingSamples} (${data.threatCount} threats, ${data.safeCount} safe)<br>
                        Features: ${data.featureNames.join(', ')}<br>
                        <pre style="background: rgba(15, 23, 42, 0.8); padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 11px; margin-top: 12px;">${JSON.stringify(data.coefficients, null, 2)}</pre>
                    `;
                    loadStatus();
                } else {
                    throw new Error(data.error || 'Training failed');
                }
            } catch (err) {
                result.style.cssText = 'margin-top: 20px; padding: 16px; border-radius: 8px; display: block; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #f87171;';
                result.innerHTML = `<strong>âœ— Training Failed</strong><br>${err.message}`;
            } finally {
                result.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'ğŸš€ Train Model Now';
            }
        }

        loadStatus();
    </script>
    <script src="/assets/js/unified-header.js"></script>
    <script src="/assets/js/unified-card-library.js"></script>
    <script src="/assets/js/unified-components.js"></script>
</body>
</html>
