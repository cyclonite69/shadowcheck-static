<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowCheck - Threat Surveillance</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            gap: 20px;
            flex-shrink: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            gap: 8px;
            justify-content: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .header-right-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            justify-content: flex-end;
        }

        .nav-link {
            border: none;
            background: rgba(59, 130, 246, 0.1);
            color: #e0e7ff;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s;
            border: 1px solid rgba(148, 163, 184, 0.2);
            text-decoration: none;
            display: inline-block;
        }

        .nav-link:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(148, 163, 184, 0.4);
        }

        .nav-link.active {
        }

        .nav-link.active[href="/"],
        .nav-link.active[href="/index.html"] {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .nav-link.active[href="/geospatial.html"] {
            background: rgba(16, 185, 129, 0.3);
            border-color: #10b981;
            color: #34d399;
        }

        .nav-link.active[href="/analytics.html"] {
            background: rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
            color: #a78bfa;
        }

        .nav-link.active[href="/surveillance.html"] {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            color: #f87171;
        }

        .nav-link.active[href="/networks.html"] {
            background: rgba(6, 182, 212, 0.3);
            border-color: #06b6d4;
            color: #22d3ee;
        }

        .nav-link.active[href="/admin.html"] {
            background: rgba(255, 255, 255, 0.15);
            border-color: #ffffff;
            color: #ffffff;
        }

            color: #3b82f6;
        }

            color: #3b82f6;
        }

        }

        }

            color: #3b82f6;
        }

            color: #ffffff;
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #cbd5e1;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
            flex: 1;
            overflow-y: auto;
        }

        .metrics-and-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 12px;
            flex-shrink: 0;
        }

        .threat-lists-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            min-height: 400px;
            flex: 1;
        }

        .panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            font-size: 13px;
            font-weight: 600;
            color: #cbd5e1;
            flex-shrink: 0;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }

        .metrics-grid {
            grid-column: 1 / 3;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 0;
        }

        .metric-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
        }

        .metric-card.critical {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .metric-card.high {
            background: rgba(251, 146, 60, 0.1);
            border-color: rgba(251, 146, 60, 0.3);
        }

        .metric-card.medium {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
        }

        .metric-card.low {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .metric-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #60a5fa;
            margin-top: 8px;
        }

        .metric-card.critical .metric-value {
            color: #ef4444;
        }

        .chart-container {
            height: 100%;
            position: relative;
        }

        .threat-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .threat-row {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-left: 3px solid #ef4444;
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .threat-row:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Severity level colors */
        .threat-row.severity-critical {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.4);
            border-left-color: #dc2626;
        }

        .threat-row.severity-critical:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .threat-row.severity-high {
            background: rgba(251, 146, 60, 0.1);
            border-color: rgba(251, 146, 60, 0.4);
            border-left-color: #ea580c;
        }

        .threat-row.severity-high:hover {
            background: rgba(251, 146, 60, 0.2);
        }

        .threat-row.severity-medium {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.4);
            border-left-color: #ca8a04;
        }

        .threat-row.severity-medium:hover {
            background: rgba(234, 179, 8, 0.2);
        }

        .threat-row.severity-low {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.4);
            border-left-color: #2563eb;
        }

        .threat-row.severity-low:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .threat-score {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
        }

        .threat-score.severity-critical {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .threat-score.severity-high {
            background: rgba(251, 146, 60, 0.3);
            color: #fdba74;
        }

        .threat-score.severity-medium {
            background: rgba(234, 179, 8, 0.3);
            color: #fde047;
        }

        .threat-score.severity-low {
            background: rgba(59, 130, 246, 0.3);
            color: #93c5fd;
        }

        .threat-info {
            flex: 1;
            min-width: 0;
        }

        .threat-title {
            font-size: 12px;
            font-weight: 600;
            color: #f1f5f9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .threat-meta {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 2px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 3px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 12px;
            padding: 20px;
        }
    </style>
    <link rel="stylesheet" href="/assets/styles/unified.css">
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">‚ö†Ô∏è</div>
                <div class="header-title">Threat Surveillance</div>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link" data-page="dashboard">Dashboard</a>
                <a href="/geospatial.html" class="nav-link" data-page="geospatial">Geospatial</a>
                <a href="/analytics.html" class="nav-link" data-page="analytics">Analytics</a>
                <a href="/surveillance.html" class="nav-link active" data-page="surveillance">Surveillance</a>
                <a href="/networks.html" class="nav-link" data-page="networks">Networks</a>
                <a href="/admin.html" class="nav-link">Admin</a>
            </div>
            <div class="header-right-group">
                <div class="status">
                    <div class="status-dot"></div>
                    <span id="status-text">Online</span>
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main">
            <!-- METRICS AND CHARTS -->
            <div class="metrics-and-charts">
                <!-- THREAT METRICS -->
                <div class="panel metrics-grid">
                    <div class="metric-card critical">
                        <div class="metric-label">Critical (80+)</div>
                        <div class="metric-value" id="critical-count">0</div>
                    </div>
                    <div class="metric-card high">
                        <div class="metric-label">High (70-79)</div>
                        <div class="metric-value" id="high-count">0</div>
                    </div>
                    <div class="metric-card medium">
                        <div class="metric-label">Medium (50-69)</div>
                        <div class="metric-value" id="medium-count">0</div>
                    </div>
                    <div class="metric-card low">
                        <div class="metric-label">Low (30-49)</div>
                        <div class="metric-value" id="low-count">0</div>
                    </div>
                </div>

                <!-- THREAT DISTRIBUTION CHART -->
                <div class="panel">
                    <div class="panel-header">üìä Threat Score Distribution</div>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="threatChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- TEMPORAL ACTIVITY CHART -->
                <div class="panel">
                    <div class="panel-header">‚è∞ Temporal Activity Patterns</div>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="temporalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- THREAT LISTS -->
            <div class="threat-lists-container">
            <!-- Active Threats -->
            <div class="panel">
                <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        üîç Active Threats - Click to Investigate
                        <span id="threat-list-count" style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 2px 8px; border-radius: 4px; font-size: 11px;">0</span>
                    </div>
                    <select id="threat-severity-filter" style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; padding: 6px 10px; border-radius: 6px; font-size: 11px;">
                        <option value="all">All Severity Levels</option>
                        <option value="critical">Critical (80+)</option>
                        <option value="high">High (70-79)</option>
                        <option value="medium">Medium (50-69)</option>
                        <option value="low">Low (30-49)</option>
                    </select>
                </div>
                <div class="panel-content" style="overflow-y: auto;">
                    <div id="threat-investigation-list" style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="loading">Loading threats...</div>
                    </div>
                </div>
            </div>

            <!-- Confirmed Threats -->
            <div class="panel">
                <div class="panel-header" style="display: flex; align-items: center; gap: 8px;">
                    <span>‚ö†Ô∏è Confirmed Threats</span>
                    <span id="confirmed-threats-count" style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 2px 8px; border-radius: 4px; font-size: 11px;">0</span>
                </div>
                <div class="panel-content" style="overflow-y: auto;">
                    <div id="confirmed-threats-list" style="display: flex; flex-direction: column; gap: 6px;">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Tagged Safe -->
            <div class="panel">
                <div class="panel-header" style="display: flex; align-items: center; gap: 8px;">
                    <span>‚úì Tagged Safe</span>
                    <span id="tagged-safe-count" style="background: rgba(34, 197, 94, 0.2); color: #4ade80; padding: 2px 8px; border-radius: 4px; font-size: 11px;">0</span>
                </div>
                <div class="panel-content" style="overflow-y: auto;">
                    <div id="tagged-safe-list" style="display: flex; flex-direction: column; gap: 6px;">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // HTML escaping utility to prevent XSS
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Use dynamic API base URL based on current window location
        const API_BASE = Object.freeze(`${window.location.protocol}//${window.location.hostname}:3001/api`);
        let threatChart = null;
        let temporalChart = null;
        let minThreatSeverity = 'all'; // Default: show all

        // Pagination state for infinite scroll
        const pagination = {
            activeThreats: { page: 1, limit: 50, hasMore: true, loading: false, totalCount: 0 },
            confirmedThreats: { page: 1, limit: 50, hasMore: true, loading: false, totalCount: 0 },
            taggedSafe: { page: 1, limit: 50, hasMore: true, loading: false, totalCount: 0 }
        };

        // Highlight active nav
        function highlightActiveNav() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('a.nav-link').forEach(link => {
                link.classList.remove('active');
                const href = link.getAttribute('href');

                if ((currentPath === '/' || currentPath === '/index.html') && (href === '/' || href === '/index.html')) {
                    link.classList.add('active');
                } else if (href !== '/' && currentPath.includes(href.replace('/', ''))) {
                    link.classList.add('active');
                }
            });
        }

        // Load metrics
        async function loadMetrics() {
            try {
                console.log('üìä Loading threat metrics...');
                // Fetch ALL threats to get accurate counts
                const response = await fetch(`${API_BASE}/threats/quick?page=1&limit=10000`);

                if (!response.ok) {
                    console.error('‚úó Metrics API failed:', response.status);
                    return;
                }

                const data = await response.json();
                const threats = data.threats || [];

                console.log(`‚úì Loaded ${threats.length} threats from API`);

                // Count threats by severity
                let criticalCount = 0;
                let highCount = 0;
                let mediumCount = 0;
                let lowCount = 0;

                threats.forEach(threat => {
                    const score = threat.threatScore;
                    if (score >= 80) {
                        criticalCount++;
                    } else if (score >= 70) {
                        highCount++;
                    } else if (score >= 50) {
                        mediumCount++;
                    } else if (score >= 30) {
                        lowCount++;
                    }
                });

                document.getElementById('critical-count').textContent = criticalCount;
                document.getElementById('high-count').textContent = highCount;
                document.getElementById('medium-count').textContent = mediumCount;
                document.getElementById('low-count').textContent = lowCount;

                console.log('‚úì Metrics loaded:', {
                    critical: criticalCount,
                    high: highCount,
                    medium: mediumCount,
                    low: lowCount,
                    total: threats.length
                });
            } catch (err) {
                console.error('‚úó Error loading metrics:', err);
            }
        }

        // Load threat distribution chart
        async function loadThreatChart() {
            try {
                console.log(`üìä Loading threat distribution (minSeverity: ${minThreatSeverity})...`);
                const url = minThreatSeverity > 0
                    ? `${API_BASE}/threats/quick?page=1&limit=100&minSeverity=${minThreatSeverity}`
                    : `${API_BASE}/threats/quick?page=1&limit=100`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.error('‚úó Threats API failed:', response.status);
                    return;
                }

                const data = await response.json();

                if (!data || !data.threats || !Array.isArray(data.threats)) {
                    console.warn('‚ö†Ô∏è No threat data available');
                    return;
                }

                const scores = data.threats.map(t => t.threatScore);
                const bins = { '30-40': 0, '40-50': 0, '50-60': 0, '60-70': 0, '70-80': 0, '80-90': 0, '90-100': 0 };

                scores.forEach(score => {
                    if (score < 40) bins['30-40']++;
                    else if (score < 50) bins['40-50']++;
                    else if (score < 60) bins['50-60']++;
                    else if (score < 70) bins['60-70']++;
                    else if (score < 80) bins['70-80']++;
                    else if (score < 90) bins['80-90']++;
                    else bins['90-100']++;
                });

                const ctx = document.getElementById('threatChart').getContext('2d');
                if (threatChart) threatChart.destroy();

                threatChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(bins),
                        datasets: [{
                            label: 'Threat Count',
                            data: Object.values(bins),
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                            x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                        }
                    }
                });

                console.log(`‚úì Threat distribution chart rendered (${data.threats.length} threats)`);
            } catch (err) {
                console.error('‚úó Error loading threat chart:', err);
            }
        }

        // Load temporal activity chart
        async function loadTemporalChart() {
            try {
                console.log('‚è∞ Loading temporal activity...');
                const response = await fetch(`${API_BASE}/analytics/temporal-activity`);

                if (!response.ok) {
                    console.error('‚úó Temporal activity API failed:', response.status);
                    return;
                }

                const data = await response.json();

                if (!data || !data.data || !Array.isArray(data.data)) {
                    console.warn('‚ö†Ô∏è No temporal activity data available');
                    return;
                }

                const ctx = document.getElementById('temporalChart').getContext('2d');
                if (temporalChart) temporalChart.destroy();

                temporalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(d => `${d.hour}:00`),
                        datasets: [{
                            label: 'Network Activity',
                            data: data.data.map(d => d.count),
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                            x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                        }
                    }
                });

                console.log('‚úì Temporal activity chart rendered');
            } catch (err) {
                console.error('‚úó Error loading temporal chart:', err);
            }
        }

        // Get severity class based on threat score
        function getSeverityClass(score) {
            if (score >= 80) return 'severity-critical';
            if (score >= 70) return 'severity-high';
            if (score >= 50) return 'severity-medium';
            return 'severity-low';
        }

        // Get severity label based on threat score
        function getSeverityLabel(score) {
            if (score >= 80) return 'Critical';
            if (score >= 70) return 'High';
            if (score >= 50) return 'Medium';
            return 'Low';
        }

        // Tag a network as safe or threat
        async function tagNetwork(bssid, tagType, confidence = 50) {
            try {
                const API_KEY = localStorage.getItem('shadowcheck_api_key') || 'your-secure-random-key-here';
                
                const response = await fetch(`${API_BASE}/tag-network`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        bssid: bssid,
                        tag_type: tagType,
                        confidence: confidence,
                        notes: `User tagged as ${tagType}`
                    })
                });

                if (!response.ok) {
                    console.error('‚úó Tag network failed:', response.status);
                    return false;
                }

                const result = await response.json();
                console.log(`‚úì Network tagged: ${bssid} as ${tagType}`);

                // Reload all lists to reflect changes
                await loadThreatList();
                await loadConfirmedThreats();
                await loadTaggedSafe();
                return true;
            } catch (err) {
                console.error('‚úó Error tagging network:', err);
                return false;
            }
        }

        // Load confirmed threats list (tagged as THREAT)
        async function loadConfirmedThreats(append = false) {
            try {
                if (pagination.confirmedThreats.loading || (!append && pagination.confirmedThreats.page !== 1)) {
                    if (!append) {
                        // Reset pagination for fresh load
                        pagination.confirmedThreats.page = 1;
                        pagination.confirmedThreats.hasMore = true;
                    }
                    if (pagination.confirmedThreats.loading) return;
                }

                pagination.confirmedThreats.loading = true;

                console.log(`üö® Loading confirmed threats (page ${pagination.confirmedThreats.page})...`);
                const response = await fetch(`${API_BASE}/networks/tagged?tag_type=THREAT&page=${pagination.confirmedThreats.page}&limit=${pagination.confirmedThreats.limit}`);

                if (!response.ok) {
                    console.error('‚úó Confirmed threats API failed:', response.status);
                    pagination.confirmedThreats.loading = false;
                    return;
                }

                const data = await response.json();
                const listEl = document.getElementById('confirmed-threats-list');
                const countEl = document.getElementById('confirmed-threats-count');

                if (!data.ok || !data.networks || data.networks.length === 0) {
                    if (!append) {
                        listEl.innerHTML = '<div class="loading">No confirmed threats</div>';
                        countEl.textContent = '0';
                    }
                    pagination.confirmedThreats.hasMore = false;
                    pagination.confirmedThreats.loading = false;
                    return;
                }

                pagination.confirmedThreats.totalCount = data.totalCount || data.networks.length;
                pagination.confirmedThreats.hasMore = (pagination.confirmedThreats.page * pagination.confirmedThreats.limit) < pagination.confirmedThreats.totalCount;

                countEl.textContent = pagination.confirmedThreats.totalCount;

                if (!append) {
                    listEl.innerHTML = '';
                }

                data.networks.forEach(network => {
                    const item = document.createElement('div');
                    item.style.cssText = `
                        background: rgba(239, 68, 68, 0.1);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        border-left: 3px solid #dc2626;
                        border-radius: 6px;
                        padding: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 11px;
                    `;

                    const timespanDays = network.observation_timespan_ms ? Math.round(parseInt(network.observation_timespan_ms) / (1000 * 60 * 60 * 24)) : 0;

                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 8px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: #fca5a5; margin-bottom: 4px;">
                                    ${escapeHtml(network.ssid) || 'Hidden Network'}
                                </div>
                                <div style="font-size: 10px; color: #94a3b8;">
                                    ${escapeHtml(network.bssid)}${network.observation_count ? ` ‚Ä¢ ${network.observation_count} obs` : ''}${network.first_seen && network.last_seen ? ` ‚Ä¢ ${new Date(parseInt(network.first_seen)).toLocaleDateString()} - ${new Date(parseInt(network.last_seen)).toLocaleDateString()} (${timespanDays}d)` : ''}
                                </div>
                            </div>
                            <button class="untag-btn" style="
                                background: rgba(148, 163, 184, 0.2);
                                border: 1px solid rgba(148, 163, 184, 0.3);
                                color: #cbd5e1;
                                padding: 4px 8px;
                                border-radius: 4px;
                                font-size: 10px;
                                cursor: pointer;
                                white-space: nowrap;
                            " title="Remove tag">
                                ‚úï Untag
                            </button>
                        </div>
                    `;

                    const untagBtn = item.querySelector('.untag-btn');
                    untagBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (confirm(`Remove THREAT tag from ${network.ssid || network.bssid}?`)) {
                            await untagNetwork(network.bssid);
                        }
                    });

                    item.addEventListener('click', () => {
                        window.location.href = `/geospatial.html?bssid=${encodeURIComponent(network.bssid)}&ssid=${encodeURIComponent(network.ssid || '')}`;
                    });

                    listEl.appendChild(item);
                });

                console.log(`‚úì Loaded ${data.networks.length} confirmed threats (page ${pagination.confirmedThreats.page})`);
                pagination.confirmedThreats.loading = false;
            } catch (err) {
                console.error('‚úó Error loading confirmed threats:', err);
                pagination.confirmedThreats.loading = false;
            }
        }

        // Load tagged safe list (tagged as FALSE_POSITIVE)
        async function loadTaggedSafe(append = false) {
            try {
                if (pagination.taggedSafe.loading || (!append && pagination.taggedSafe.page !== 1)) {
                    if (!append) {
                        // Reset pagination for fresh load
                        pagination.taggedSafe.page = 1;
                        pagination.taggedSafe.hasMore = true;
                    }
                    if (pagination.taggedSafe.loading) return;
                }

                pagination.taggedSafe.loading = true;

                console.log(`‚úÖ Loading tagged safe networks (page ${pagination.taggedSafe.page})...`);
                const response = await fetch(`${API_BASE}/networks/tagged?tag_type=FALSE_POSITIVE&page=${pagination.taggedSafe.page}&limit=${pagination.taggedSafe.limit}`);

                if (!response.ok) {
                    console.error('‚úó Tagged safe API failed:', response.status);
                    pagination.taggedSafe.loading = false;
                    return;
                }

                const data = await response.json();
                const listEl = document.getElementById('tagged-safe-list');
                const countEl = document.getElementById('tagged-safe-count');

                if (!data.ok || !data.networks || data.networks.length === 0) {
                    if (!append) {
                        listEl.innerHTML = '<div class="loading">No safe networks</div>';
                        countEl.textContent = '0';
                    }
                    pagination.taggedSafe.hasMore = false;
                    pagination.taggedSafe.loading = false;
                    return;
                }

                pagination.taggedSafe.totalCount = data.totalCount || data.networks.length;
                pagination.taggedSafe.hasMore = (pagination.taggedSafe.page * pagination.taggedSafe.limit) < pagination.taggedSafe.totalCount;

                countEl.textContent = pagination.taggedSafe.totalCount;

                if (!append) {
                    listEl.innerHTML = '';
                }

                data.networks.forEach(network => {
                    const item = document.createElement('div');
                    item.style.cssText = `
                        background: rgba(34, 197, 94, 0.1);
                        border: 1px solid rgba(34, 197, 94, 0.3);
                        border-left: 3px solid #16a34a;
                        border-radius: 6px;
                        padding: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 11px;
                        opacity: 0.7;
                    `;

                    const timespanDays = network.observation_timespan_ms ? Math.round(parseInt(network.observation_timespan_ms) / (1000 * 60 * 60 * 24)) : 0;

                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 8px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: #4ade80; margin-bottom: 4px;">
                                    ${escapeHtml(network.ssid) || 'Hidden Network'}
                                </div>
                                <div style="font-size: 10px; color: #94a3b8;">
                                    ${escapeHtml(network.bssid)}${network.observation_count ? ` ‚Ä¢ ${network.observation_count} obs` : ''}${network.first_seen && network.last_seen ? ` ‚Ä¢ ${new Date(parseInt(network.first_seen)).toLocaleDateString()} - ${new Date(parseInt(network.last_seen)).toLocaleDateString()} (${timespanDays}d)` : ''}
                                </div>
                            </div>
                            <button class="untag-btn" style="
                                background: rgba(148, 163, 184, 0.2);
                                border: 1px solid rgba(148, 163, 184, 0.3);
                                color: #cbd5e1;
                                padding: 4px 8px;
                                border-radius: 4px;
                                font-size: 10px;
                                cursor: pointer;
                                white-space: nowrap;
                            " title="Remove tag">
                                ‚úï Untag
                            </button>
                        </div>
                    `;

                    const untagBtn = item.querySelector('.untag-btn');
                    untagBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (confirm(`Remove SAFE tag from ${network.ssid || network.bssid}?`)) {
                            await untagNetwork(network.bssid);
                        }
                    });

                    item.addEventListener('click', () => {
                        window.location.href = `/geospatial.html?bssid=${encodeURIComponent(network.bssid)}&ssid=${encodeURIComponent(network.ssid || '')}`;
                    });

                    listEl.appendChild(item);
                });

                console.log(`‚úì Loaded ${data.networks.length} safe networks (page ${pagination.taggedSafe.page})`);
                pagination.taggedSafe.loading = false;
            } catch (err) {
                console.error('‚úó Error loading safe networks:', err);
                pagination.taggedSafe.loading = false;
            }
        }

        // Untag a network (remove all tags)
        async function untagNetwork(bssid) {
            try {
                const response = await fetch(`${API_BASE}/tag-network/${bssid}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    console.error('‚úó Untag network failed:', response.status);
                    return false;
                }

                const result = await response.json();
                console.log(`‚úì Network untagged: ${bssid}`);

                // Reload all lists to reflect changes
                await loadThreatList();
                await loadConfirmedThreats();
                await loadTaggedSafe();
                return true;
            } catch (err) {
                console.error('‚úó Error untagging network:', err);
                return false;
            }
        }

        // Load threat list for investigation
        async function loadThreatList(append = false) {
            try {
                if (pagination.activeThreats.loading || (!append && pagination.activeThreats.page !== 1)) {
                    if (!append) {
                        // Reset pagination for fresh load
                        pagination.activeThreats.page = 1;
                        pagination.activeThreats.hasMore = true;
                    }
                    if (pagination.activeThreats.loading) return;
                }

                pagination.activeThreats.loading = true;

                console.log(`üîç Loading threat investigation list (page ${pagination.activeThreats.page}, severity filter: ${minThreatSeverity})...`);
                const url = `${API_BASE}/threats/quick?page=${pagination.activeThreats.page}&limit=${pagination.activeThreats.limit}`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.error('‚úó Threats API failed:', response.status);
                    pagination.activeThreats.loading = false;
                    return;
                }

                const data = await response.json();

                const listEl = document.getElementById('threat-investigation-list');
                const countEl = document.getElementById('threat-list-count');

                if (!data || !data.threats || !Array.isArray(data.threats) || data.threats.length === 0) {
                    if (!append) {
                        listEl.innerHTML = '<div class="loading">No threats detected</div>';
                        countEl.textContent = '0';
                    }
                    pagination.activeThreats.hasMore = false;
                    pagination.activeThreats.loading = false;
                    return;
                }

                // Update pagination info
                pagination.activeThreats.totalCount = data.total || data.threats.length;
                pagination.activeThreats.hasMore = (pagination.activeThreats.page * pagination.activeThreats.limit) < pagination.activeThreats.totalCount;

                // Filter threats by selected severity level
                let filteredThreats = data.threats;
                if (minThreatSeverity !== 'all') {
                    filteredThreats = data.threats.filter(threat => {
                        const severityClass = getSeverityClass(threat.threatScore);
                        return severityClass === `severity-${minThreatSeverity}`;
                    });
                }

                if (filteredThreats.length === 0 && !append) {
                    listEl.innerHTML = '<div class="loading">No threats at this severity level</div>';
                    countEl.textContent = '0';
                    pagination.activeThreats.loading = false;
                    return;
                }

                // Only update count on first load
                if (!append) {
                    countEl.textContent = pagination.activeThreats.totalCount;
                    listEl.innerHTML = '';
                }

                filteredThreats.forEach(threat => {
                    const item = document.createElement('div');
                    const severityClass = getSeverityClass(threat.threatScore);
                    const severityLabel = getSeverityLabel(threat.threatScore);

                    item.className = `threat-row ${severityClass}`;

                    item.innerHTML = `
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <div style="font-weight: 600; font-size: 13px; color: #f1f5f9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${escapeHtml(threat.ssid) || 'Hidden Network'}
                                </div>
                                <span class="threat-score ${severityClass}">${escapeHtml(severityLabel)}: ${threat.threatScore}</span>
                            </div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">
                                ${escapeHtml(threat.bssid)} ‚Ä¢ ${threat.totalObservations} obs ‚Ä¢ ${new Date(parseInt(threat.firstSeen)).toLocaleDateString()} - ${new Date(parseInt(threat.lastSeen)).toLocaleDateString()} (${threat.timespanDays}d)
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; flex-shrink: 0;">
                            <button class="tag-safe-btn" style="
                                background: rgba(34, 197, 94, 0.2);
                                border: 1px solid rgba(34, 197, 94, 0.4);
                                color: #4ade80;
                                padding: 4px 8px;
                                border-radius: 4px;
                                font-size: 10px;
                                font-weight: 600;
                                cursor: pointer;
                                white-space: nowrap;
                            " title="Mark as safe (false positive)">
                                ‚úì Safe
                            </button>
                            <button class="tag-threat-btn" style="
                                background: rgba(239, 68, 68, 0.2);
                                border: 1px solid rgba(239, 68, 68, 0.4);
                                color: #f87171;
                                padding: 4px 8px;
                                border-radius: 4px;
                                font-size: 10px;
                                font-weight: 600;
                                cursor: pointer;
                                white-space: nowrap;
                            " title="Confirm as threat">
                                ‚ö† Threat
                            </button>
                            <button class="investigate-btn" style="
                                background: rgba(59, 130, 246, 0.2);
                                border: 1px solid rgba(59, 130, 246, 0.4);
                                color: #60a5fa;
                                padding: 4px 8px;
                                border-radius: 4px;
                                font-size: 10px;
                                font-weight: 600;
                                cursor: pointer;
                                white-space: nowrap;
                            " title="Investigate on map">
                                üîç Map
                            </button>
                        </div>
                    `;

                    // Add event listeners for tagging buttons
                    const safeBtn = item.querySelector('.tag-safe-btn');
                    const threatBtn = item.querySelector('.tag-threat-btn');
                    const investigateBtn = item.querySelector('.investigate-btn');

                    // Check if already tagged and update button state
                    if (threat.isTagged) {
                        if (threat.userTag === 'FALSE_POSITIVE') {
                            safeBtn.style.background = 'rgba(34, 197, 94, 0.5)';
                            safeBtn.style.borderColor = '#22c55e';
                            safeBtn.disabled = true;
                            safeBtn.style.opacity = '1';
                            safeBtn.style.cursor = 'not-allowed';
                        } else if (threat.userTag === 'THREAT') {
                            threatBtn.style.background = 'rgba(239, 68, 68, 0.5)';
                            threatBtn.style.borderColor = '#ef4444';
                            threatBtn.disabled = true;
                            threatBtn.style.opacity = '1';
                            threatBtn.style.cursor = 'not-allowed';
                        }
                    }

                    safeBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const success = await tagNetwork(threat.bssid, 'FALSE_POSITIVE', 90);
                        if (success) {
                            safeBtn.style.background = 'rgba(34, 197, 94, 0.5)';
                            safeBtn.style.borderColor = '#22c55e';
                            safeBtn.disabled = true;
                            safeBtn.style.opacity = '1';
                            safeBtn.style.cursor = 'not-allowed';
                        }
                    });

                    threatBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const success = await tagNetwork(threat.bssid, 'THREAT', 90);
                        if (success) {
                            threatBtn.style.background = 'rgba(239, 68, 68, 0.5)';
                            threatBtn.style.borderColor = '#ef4444';
                            threatBtn.disabled = true;
                            threatBtn.style.opacity = '1';
                            threatBtn.style.cursor = 'not-allowed';
                        }
                    });

                    investigateBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        investigateThreat(threat.bssid, threat.ssid);
                    });

                    item.addEventListener('click', () => {
                        investigateThreat(threat.bssid, threat.ssid);
                    });

                    listEl.appendChild(item);
                });

                console.log(`‚úì Loaded ${data.threats.length} threats for investigation (page ${pagination.activeThreats.page})`);
                pagination.activeThreats.loading = false;
            } catch (err) {
                console.error('‚úó Error loading threat list:', err);
                pagination.activeThreats.loading = false;
            }
        }

        // Navigate to geospatial page with threat selected
        function investigateThreat(bssid, ssid) {
            console.log(`üéØ Investigating threat: ${ssid || 'Hidden'} (${bssid})`);
            window.location.href = `/geospatial.html?bssid=${encodeURIComponent(bssid)}&ssid=${encodeURIComponent(ssid || '')}`;
        }

        // Setup infinite scroll for all three lists
        function setupInfiniteScroll() {
            // Active Threats list
            const activeThreatsList = document.querySelector('#threat-investigation-list').parentElement;
            activeThreatsList.addEventListener('scroll', () => {
                if (pagination.activeThreats.loading || !pagination.activeThreats.hasMore) return;

                const { scrollTop, scrollHeight, clientHeight } = activeThreatsList;
                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    console.log('üìú Loading more active threats...');
                    pagination.activeThreats.page++;
                    loadThreatList(true);
                }
            });

            // Confirmed Threats list
            const confirmedThreatsList = document.querySelector('#confirmed-threats-list').parentElement;
            confirmedThreatsList.addEventListener('scroll', () => {
                if (pagination.confirmedThreats.loading || !pagination.confirmedThreats.hasMore) return;

                const { scrollTop, scrollHeight, clientHeight } = confirmedThreatsList;
                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    console.log('üìú Loading more confirmed threats...');
                    pagination.confirmedThreats.page++;
                    loadConfirmedThreats(true);
                }
            });

            // Tagged Safe list
            const taggedSafeList = document.querySelector('#tagged-safe-list').parentElement;
            taggedSafeList.addEventListener('scroll', () => {
                if (pagination.taggedSafe.loading || !pagination.taggedSafe.hasMore) return;

                const { scrollTop, scrollHeight, clientHeight } = taggedSafeList;
                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    console.log('üìú Loading more tagged safe networks...');
                    pagination.taggedSafe.page++;
                    loadTaggedSafe(true);
                }
            });

            console.log('‚úì Infinite scroll setup complete for all three lists');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            highlightActiveNav();
            loadMetrics();
            loadThreatChart();
            loadTemporalChart();
            loadThreatList();
            loadConfirmedThreats();
            loadTaggedSafe();
            setupInfiniteScroll();

            // Wire up threat severity filter
            const severityFilter = document.getElementById('threat-severity-filter');
            if (severityFilter) {
                severityFilter.addEventListener('change', (e) => {
                    minThreatSeverity = e.target.value;
                    console.log(`üéöÔ∏è Threat severity filter changed to: ${minThreatSeverity}`);
                    loadThreatList();
                    // Note: chart still shows all threats for context
                });
            }
        });
    </script>
    <script src="/assets/js/unified-header.js"></script>
    <script src="/assets/js/unified-card-library.js"></script>
    <script src="/assets/js/unified-components.js"></script>
</body>
</html>