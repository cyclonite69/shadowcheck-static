<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowCheck - Analytics</title>
    <link rel="stylesheet" href="/assets/styles/unified.css">
</head>
<body data-page="analytics">
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <div class="logo">SC</div>
                <span class="font-semibold">ShadowCheck</span>
            </div>
            <nav class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/networks.html" class="nav-link">Networks</a>
                <a href="/geospatial.html" class="nav-link">Geospatial</a>
                <a href="/surveillance.html" class="nav-link">Surveillance</a>
                <a href="/analytics.html" class="nav-link active">Analytics</a>
                <a href="/admin.html" class="nav-link">Admin</a>
            </nav>
            <div class="header-right">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Online</span>
                </div>
            </div>
        </header>

        <main class="app-main">
<div class="main">
            <!-- Network Types -->
            <div class="panel">
                <div class="panel-header">üì° Network Types Distribution</div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="networkTypesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Signal Strength -->
            <div class="panel">
                <div class="panel-header">üì∂ Signal Strength Distribution</div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="signalStrengthChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Security Types -->
            <div class="panel">
                <div class="panel-header">üîê Security Distribution</div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="securityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Temporal Activity -->
            <div class="panel">
                <div class="panel-header">‚è∞ Temporal Activity Patterns</div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="temporalChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Radio Type Over Time -->
            <div class="panel">
                <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üìä Network Types Over Time</span>
                    <select id="timeRange" onchange="loadRadioTypeTime()" style="background: rgba(30, 41, 59, 0.8); color: #e0e7ff; border: 1px solid rgba(148, 163, 184, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        <option value="24h">24 Hours</option>
                        <option value="7d">7 Days</option>
                        <option value="30d" selected>30 Days</option>
                        <option value="90d">90 Days</option>
                        <option value="1y">1 Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="radioTypeTimeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top 100 WiFi Networks -->
            <div class="panel">
                <div class="panel-header">üèÜ Top 100 WiFi Networks by Observations</div>
                <div class="panel-content" style="overflow-y: auto;">
                    <div id="topNetworksList" style="padding: 8px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use dynamic API base URL based on current window location
        const API_BASE = Object.freeze(`${window.location.protocol}//${window.location.hostname}:3001/api`);
        const charts = {};

        // Highlight active nav
        function highlightActiveNav() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('a.nav-link').forEach(link => {
                link.classList.remove('active');
                const href = link.getAttribute('href');

                if ((currentPath === '/' || currentPath === '/index.html') && (href === '/' || href === '/index.html')) {
                    link.classList.add('active');
                } else if (href !== '/' && currentPath.includes(href.replace('/', ''))) {
                    link.classList.add('active');
                }
            });
        }

        // Create chart with enhanced tooltips
        function createChart(canvasId, type, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            // Calculate total for percentage calculation
            const total = data.reduce((sum, val) => sum + val, 0);

            // Build options based on chart type
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#cbd5e1' },
                        display: type !== 'line' || canvasId !== 'signalStrengthChart'
                    },
                    tooltip: {
                        callbacks: {}
                    }
                },
                scales: (type !== 'doughnut' && type !== 'pie') ? {
                    x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                    y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' }, beginAtZero: true }
                } : undefined
            };

            // Add percentage tooltip for doughnut/pie charts
            if (type === 'doughnut' || type === 'pie') {
                options.plugins.tooltip.callbacks.label = function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} (${percentage}%)`;
                };
            }

            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#8b5cf6', '#ec4899',
                            '#f59e0b', '#06b6d4', '#ef4444', '#a78bfa'
                        ],
                        borderColor: 'transparent',
                        borderWidth: type === 'line' ? 2 : 0
                    }]
                },
                options: options
            });
        }

        // Load network types
        async function loadNetworkTypes() {
            try {
                console.log('üì° Loading network types...');
                const res = await fetch(`${API_BASE}/analytics/network-types`);

                if (!res.ok) {
                    console.error('‚úó Network types API failed:', res.status);
                    return;
                }

                const data = await res.json();

                if (!data || !data.data || !Array.isArray(data.data)) {
                    console.warn('‚ö†Ô∏è No network types data available');
                    return;
                }

                const typeMap = { 'W': 'WiFi', 'E': 'BLE', 'B': 'BT', 'L': 'LTE', 'N': '5G NR', 'G': 'GSM' };
                const labels = data.data.map(d => typeMap[d.type] || d.type);
                const values = data.data.map(d => d.count);

                createChart('networkTypesChart', 'doughnut', labels, values);
                console.log('‚úì Network types chart rendered');
            } catch (err) {
                console.error('‚úó Error loading network types:', err);
            }
        }

        // Load signal strength
        async function loadSignalStrength() {
            try {
                console.log('üì∂ Loading signal strength...');
                const res = await fetch(`${API_BASE}/analytics/signal-strength`);

                if (!res.ok) {
                    console.error('‚úó Signal strength API failed:', res.status);
                    return;
                }

                const data = await res.json();

                if (!data || !data.data || !Array.isArray(data.data)) {
                    console.warn('‚ö†Ô∏è No signal strength data available');
                    return;
                }

                const labels = data.data.map(d => d.range + ' dBm');
                const values = data.data.map(d => d.count);

                createChart('signalStrengthChart', 'line', labels, values);
                console.log('‚úì Signal strength chart rendered');
            } catch (err) {
                console.error('‚úó Error loading signal strength:', err);
            }
        }

        // Load security
        async function loadSecurity() {
            try {
                console.log('üîê Loading security distribution...');
                const res = await fetch(`${API_BASE}/analytics/security`);

                if (!res.ok) {
                    console.error('‚úó Security API failed:', res.status);
                    return;
                }

                const data = await res.json();

                if (!data || !data.data || !Array.isArray(data.data)) {
                    console.warn('‚ö†Ô∏è No security data available');
                    return;
                }

                const labels = data.data.map(d => d.type);
                const values = data.data.map(d => d.count);

                createChart('securityChart', 'doughnut', labels, values);
                console.log('‚úì Security chart rendered');
            } catch (err) {
                console.error('‚úó Error loading security:', err);
            }
        }

        // Load temporal activity
        async function loadTemporal() {
            try {
                console.log('‚è∞ Loading temporal activity...');
                const res = await fetch(`${API_BASE}/analytics/temporal-activity`);

                if (!res.ok) {
                    console.error('‚úó Temporal activity API failed:', res.status);
                    return;
                }

                const data = await res.json();

                if (!data || !data.data || !Array.isArray(data.data)) {
                    console.warn('‚ö†Ô∏è No temporal activity data available');
                    return;
                }

                const labels = data.data.map(d => `${d.hour}:00`);
                const values = data.data.map(d => d.count);

                createChart('temporalChart', 'bar', labels, values);
                console.log('‚úì Temporal activity chart rendered');
            } catch (err) {
                console.error('‚úó Error loading temporal activity:', err);
            }
        }

        // Load radio type over time
        async function loadRadioTypeTime() {
            try {
                const range = document.getElementById('timeRange')?.value || '30d';
                console.log(`üìä Loading radio type over time (${range})...`);

                const res = await fetch(`${API_BASE}/analytics/radio-type-over-time?range=${range}`);

                if (!res.ok) {
                    console.error('‚úó Radio type over time API failed:', res.status);
                    return;
                }

                const data = await res.json();

                if (!data || !data.data || !Array.isArray(data.data)) {
                    console.warn('‚ö†Ô∏è No radio type time data available');
                    return;
                }

                // Group data by date and type, maintaining chronological order
                const dateMap = new Map();
                const types = new Set();

                // First, collect unique dates and types
                data.data.forEach(item => {
                    const date = new Date(item.date);
                    const timestamp = date.getTime();

                    if (!dateMap.has(timestamp)) {
                        dateMap.set(timestamp, { date: date, types: {} });
                    }

                    dateMap.get(timestamp).types[item.type] = item.count;
                    types.add(item.type);
                });

                // Sort by timestamp and format labels
                const sortedEntries = Array.from(dateMap.entries()).sort((a, b) => a[0] - b[0]);

                const dates = sortedEntries.map(([timestamp, data]) => {
                    const date = data.date;

                    // Format based on time range
                    if (range === '24h') {
                        return date.toLocaleString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            hour12: true
                        });
                    } else if (range === 'all') {
                        return date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: '2-digit'
                        });
                    } else {
                        return date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                });

                const typesList = Array.from(types).sort();

                console.log(`  ‚Ü≥ Time range: ${range}`);
                console.log(`  ‚Ü≥ Data points: ${sortedEntries.length}`);
                console.log(`  ‚Ü≥ Network types: ${typesList.join(', ')}`);
                console.log(`  ‚Ü≥ Date range: ${dates[0]} ‚Üí ${dates[dates.length - 1]}`);

                // Create datasets for each network type with high-contrast colors
                const datasets = typesList.map((type, idx) => {
                    // High-contrast, colorblind-safe palette
                    const colors = {
                        'WiFi': '#FF6B6B',    // Coral Red
                        'BLE': '#4ECDC4',     // Turquoise
                        'BT': '#FFE66D',      // Yellow
                        'LTE': '#95E1D3',     // Mint Green
                        'NR': '#C7CEEA',      // Lavender
                        'GSM': '#FFA07A'      // Light Salmon
                    };

                    return {
                        label: type,
                        data: sortedEntries.map(([timestamp, entry]) => entry.types[type] || 0),
                        borderColor: colors[type] || `hsl(${idx * 60}, 70%, 50%)`,
                        backgroundColor: colors[type] || `hsl(${idx * 60}, 70%, 50%)`,
                        borderWidth: 3,  // Increased from 2 for better visibility
                        fill: false,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    };
                });

                const ctx = document.getElementById('radioTypeTimeChart');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (charts['radioTypeTimeChart']) {
                    charts['radioTypeTimeChart'].destroy();
                }

                charts['radioTypeTimeChart'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { color: '#cbd5e1', font: { size: 11 } }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#94a3b8', font: { size: 10 } },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            },
                            y: {
                                ticks: { color: '#94a3b8', font: { size: 10 } },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                stacked: false
                            }
                        }
                    }
                });

                console.log('‚úì Radio type over time chart rendered');
            } catch (err) {
                console.error('‚úó Error loading radio type over time:', err);
            }
        }

        // Load top 100 WiFi networks by observations
        async function loadTopNetworks() {
            try {
                // Fetch more networks to ensure we get 100 WiFi networks after filtering
                const response = await fetch(`${API_BASE}/networks?page=1&limit=500&sort=observations&order=DESC`);
                const data = await response.json();

                // Filter only WiFi networks (type='W') and take top 100
                const wifiNetworks = data.networks.filter(net => net.type === 'W').slice(0, 100);

                const list = document.getElementById('topNetworksList');
                const typeIcons = { W: 'üì∂', E: 'üîµ', B: 'üî∑', L: 'üì±', N: 'üöÄ', G: 'üìû' };
                const medals = ['ü•á', 'ü•à', 'ü•â'];

                console.log(`üìä Showing top ${wifiNetworks.length} WiFi networks (filtered from ${data.networks.length} total)`);

                list.innerHTML = wifiNetworks.map((net, idx) => {
                    const lastSeen = net.lastSeen ? new Date(net.lastSeen).toLocaleDateString() : 'Unknown';
                    const ssid = net.ssid || 'Hidden';
                    return `
                    <div style="display: flex; flex-direction: column; gap: 6px; padding: 10px 12px; background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(30, 41, 59, 0.3)); border-radius: 8px; margin-bottom: 8px; border: 1px solid ${idx < 3 ? 'rgba(251, 191, 36, 0.3)' : 'rgba(148, 163, 184, 0.15)'}; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; gap: 10px; align-items: center; flex: 1; min-width: 0;">
                                <span style="font-size: 18px; min-width: 24px;">${idx < 3 ? medals[idx] : `<span style="color: #64748b; font-weight: 600; font-size: 12px;">#${idx + 1}</span>`}</span>
                                <span style="font-size: 20px;">${typeIcons[net.type] || 'üì°'}</span>
                                <div style="display: flex; flex-direction: column; min-width: 0; flex: 1;">
                                    <span style="font-family: 'Courier New', monospace; font-size: 12px; color: #cbd5e1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500;">${net.bssid}</span>
                                    <span style="font-size: 11px; color: #94a3b8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ssid}</span>
                                </div>
                            </div>
                            <span style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3)); padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; border: 1px solid rgba(99, 102, 241, 0.4); color: #e0e7ff; white-space: nowrap; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);">${net.observations.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; gap: 12px; font-size: 10px; color: #64748b; padding-left: 54px;">
                            <span>üì° ${net.security || 'N/A'}</span>
                            <span>üì∂ ${net.signal ? net.signal + ' dBm' : 'N/A'}</span>
                            <span>üïê ${lastSeen}</span>
                        </div>
                    </div>
                `}).join('');
            } catch (err) {
                console.error('‚úó Error loading top networks:', err);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            highlightActiveNav();
            loadNetworkTypes();
            loadSignalStrength();
            loadSecurity();
            loadTemporal();
            loadRadioTypeTime();
            loadTopNetworks();
        });
    </script>
    
    
    <script src="/assets/js/base-components.js"></script>
</body>
</html>