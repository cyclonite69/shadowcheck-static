# PostgreSQL Performance Tuning for ShadowCheck
# t4g.large: 2 vCPU, 8GB RAM, NVMe SSD
# Database: ~2.1GB (566k observations, 173k networks)
# Workload: Read-heavy with geospatial queries

# ============================================================================
# MEMORY CONFIGURATION (8GB RAM)
# ============================================================================
shared_buffers = 2GB                    # 25% of RAM (PostgreSQL recommendation)
effective_cache_size = 6GB              # 75% of RAM (OS + PostgreSQL cache)
maintenance_work_mem = 512MB            # For VACUUM, CREATE INDEX, ANALYZE
work_mem = 16MB                         # Per query operation (increased for PostGIS)
temp_buffers = 16MB                     # Temporary tables per session

# ============================================================================
# QUERY PLANNER
# ============================================================================
random_page_cost = 1.1                  # NVMe SSD (default 4.0 for HDD)
effective_io_concurrency = 200          # NVMe can handle many concurrent I/O
seq_page_cost = 1.0                     # Sequential scan cost

# ============================================================================
# WAL & CHECKPOINTS
# ============================================================================
wal_buffers = 16MB                      # WAL buffer size
min_wal_size = 1GB                      # Minimum WAL size
max_wal_size = 4GB                      # Maximum WAL size before checkpoint
checkpoint_completion_target = 0.9      # Spread checkpoint I/O over 90% of interval
checkpoint_timeout = 15min              # Maximum time between checkpoints

# ============================================================================
# PARALLEL PROCESSING (2 vCPU)
# ============================================================================
max_worker_processes = 2                # Background workers
max_parallel_workers = 2                # Total parallel workers
max_parallel_workers_per_gather = 1     # Per query parallel workers
max_parallel_maintenance_workers = 1    # For CREATE INDEX, VACUUM

# ============================================================================
# CONNECTION POOLING
# ============================================================================
max_connections = 100                   # Maximum connections
shared_preload_libraries = 'postgis-3'  # PostGIS extension

# ============================================================================
# AUTOVACUUM (Critical for PostGIS)
# ============================================================================
autovacuum = on                         # Enable autovacuum
autovacuum_max_workers = 2              # Parallel vacuum workers
autovacuum_naptime = 30s                # Check interval
autovacuum_vacuum_scale_factor = 0.1    # Vacuum when 10% of rows change
autovacuum_analyze_scale_factor = 0.05  # Analyze when 5% of rows change

# ============================================================================
# QUERY OPTIMIZATION
# ============================================================================
default_statistics_target = 100         # Statistics detail (default 100)
constraint_exclusion = partition        # Enable for partitioned tables
enable_partitionwise_join = on          # Optimize partitioned joins
enable_partitionwise_aggregate = on     # Optimize partitioned aggregates

# ============================================================================
# GEOSPATIAL OPTIMIZATION (PostGIS)
# ============================================================================
# These settings optimize PostGIS spatial queries
jit = on                                # Just-in-time compilation (PG 11+)
jit_above_cost = 100000                 # Enable JIT for expensive queries
jit_inline_above_cost = 500000          # Inline functions in JIT
jit_optimize_above_cost = 500000        # Optimize JIT code

# ============================================================================
# LOGGING (Security + Performance)
# ============================================================================
log_statement = 'none'                  # No statement logging (security)
log_connections = off                   # No connection logging (security)
log_disconnections = off                # No disconnection logging (security)
log_duration = off                      # No duration logging (security)
log_min_duration_statement = -1         # Disable slow query logging
log_checkpoints = on                    # Log checkpoints (performance monitoring)
log_autovacuum_min_duration = 0         # Log all autovacuum runs

# ============================================================================
# SECURITY
# ============================================================================
password_encryption = scram-sha-256     # Strongest PostgreSQL auth
ssl = on                                # Require SSL/TLS
ssl_cert_file = '/var/lib/postgresql/certs/server.crt'
ssl_key_file = '/var/lib/postgresql/certs/server.key'

# ============================================================================
# MONITORING
# ============================================================================
track_activities = on                   # Track running queries
track_counts = on                       # Track table statistics
track_io_timing = on                    # Track I/O timing (useful for NVMe)
track_functions = pl                    # Track PL/pgSQL function calls

# ============================================================================
# NOTES
# ============================================================================
# - work_mem increased to 16MB (from 10MB) for complex PostGIS queries
# - JIT enabled for expensive geospatial operations
# - Autovacuum tuned for frequent updates (observations table)
# - track_io_timing enabled to monitor NVMe performance
# - All security settings preserved (no password logging)
