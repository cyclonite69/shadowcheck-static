<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Right-Click Context Menu Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .network-row { 
            padding: 10px; 
            border: 1px solid #ddd; 
            margin: 5px 0; 
            cursor: pointer;
            background: #f9f9f9;
        }
        .network-row:hover { background: #e9e9e9; }
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .context-menu-item:hover { background: #f0f0f0; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        .modal-content {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
        }
        .note-badge { 
            background: #007bff; 
            color: white; 
            border-radius: 10px; 
            padding: 2px 6px; 
            font-size: 12px; 
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1>Network Right-Click Context Menu Test</h1>
    
    <div class="network-row" data-bssid="AA:BB:CC:DD:EE:FF">
        <strong>AA:BB:CC:DD:EE:FF</strong> - Test Network 1
        <span class="note-badge">2 notes</span>
    </div>
    
    <div class="network-row" data-bssid="11:22:33:44:55:66">
        <strong>11:22:33:44:55:66</strong> - Test Network 2
    </div>
    
    <div class="network-row" data-bssid="FF:EE:DD:CC:BB:AA">
        <strong>FF:EE:DD:CC:BB:AA</strong> - Test Network 3
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="addNote()">üìù Add Note</div>
        <div class="context-menu-item" onclick="attachMedia()">üìé Attach Media</div>
        <div class="context-menu-item" onclick="tagThreat()">‚ö†Ô∏è Tag as Threat</div>
        <div class="context-menu-item" onclick="viewDetails()">üëÅÔ∏è View Details</div>
    </div>

    <!-- Add Note Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <h3>Add Note</h3>
            <p>Network: <strong id="modalBssid"></strong></p>
            <textarea id="noteContent" placeholder="Enter your note..." rows="4" style="width: 100%; margin: 10px 0;"></textarea>
            <select id="noteType" style="margin: 10px 0;">
                <option value="general">General</option>
                <option value="observation">Observation</option>
                <option value="technical">Technical</option>
                <option value="location">Location</option>
                <option value="behavior">Behavior</option>
            </select>
            <div>
                <button onclick="saveNote()">Save Note</button>
                <button onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentBssid = null;

        // Right-click handler
        document.addEventListener('contextmenu', function(e) {
            const networkRow = e.target.closest('.network-row');
            if (networkRow) {
                e.preventDefault();
                currentBssid = networkRow.dataset.bssid;
                
                const contextMenu = document.getElementById('contextMenu');
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
            }
        });

        // Hide context menu on click elsewhere
        document.addEventListener('click', function() {
            document.getElementById('contextMenu').style.display = 'none';
        });

        // Context menu actions
        function addNote() {
            document.getElementById('modalBssid').textContent = currentBssid;
            document.getElementById('noteModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        function attachMedia() {
            alert('Media attachment for ' + currentBssid + ' (not implemented yet)');
        }

        function tagThreat() {
            if (confirm('Tag ' + currentBssid + ' as threat?')) {
                // Call API to tag as threat
                fetch('/api/admin/network-tags/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bssid: currentBssid, tag: 'THREAT' })
                }).then(r => r.json()).then(data => {
                    alert('Tagged as threat: ' + data.message);
                });
            }
        }

        function viewDetails() {
            window.open('/api/admin/network-summary/' + currentBssid, '_blank');
        }

        function closeModal() {
            document.getElementById('noteModal').style.display = 'none';
            document.getElementById('noteContent').value = '';
        }

        function saveNote() {
            const content = document.getElementById('noteContent').value;
            const noteType = document.getElementById('noteType').value;
            
            if (!content.trim()) {
                alert('Please enter a note');
                return;
            }

            // Call API to save note
            fetch('/api/admin/add-note', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    bssid: currentBssid, 
                    content: content,
                    note_type: noteType 
                })
            }).then(r => r.json()).then(data => {
                if (data.ok) {
                    alert('Note saved successfully!');
                    closeModal();
                    // Update note badge
                    updateNoteBadge(currentBssid);
                } else {
                    alert('Error saving note: ' + data.error);
                }
            }).catch(err => {
                alert('Error: ' + err.message);
            });
        }

        function updateNoteBadge(bssid) {
            // Refresh note count for the network
            fetch('/api/admin/network-summary/' + bssid)
                .then(r => r.json())
                .then(data => {
                    const row = document.querySelector(`[data-bssid="${bssid}"]`);
                    const existingBadge = row.querySelector('.note-badge');
                    const noteCount = data.network.notation_count || 0;
                    
                    if (noteCount > 0) {
                        if (existingBadge) {
                            existingBadge.textContent = noteCount + ' notes';
                        } else {
                            const badge = document.createElement('span');
                            badge.className = 'note-badge';
                            badge.textContent = noteCount + ' notes';
                            row.appendChild(badge);
                        }
                    }
                });
        }
    </script>
</body>
</html>
